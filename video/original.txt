using UdonSharp;
using UnityEngine;
using VRC.SDKBase;
using VRC.SDK3.Data;
using VRC.Udon;

namespace Wacky612.PortalLibrarySystem2
{
    public abstract class BaseWorldData : UdonSharpBehaviour
    {
        private protected WorldDataProcessor _worldDataProcessor;
    
        public abstract float WorldDataLoadDelaySeconds  { get; }
        public abstract float ThumbnailsLoadDelaySeconds { get; }

        public virtual void Initialize()
        {
            _worldDataProcessor = GetComponentInParent<WorldDataProcessor>();
        }

        public abstract void LoadWorldData();
        public abstract void LoadThumbnails();
        public abstract Texture GetThumbnail(int index);
    }
}

using UdonSharp;
using UnityEngine;
using UnityEngine.UI;
using VRC.SDKBase;
using VRC.Udon;
using TMPro;

namespace Wacky612.PortalLibrarySystem2
{
    public abstract class Button : UdonSharpBehaviour
    {
        [SerializeField] private protected RectTransform _text;

        [SerializeField] private Image _background;
        [SerializeField] private Color _unselectedColor   = Color.white;
        [SerializeField] private Color _selectedColor     = new Color(0.5f, 1.0f, 1.0f, 1.0f);
        [SerializeField] private Color _invalidColor      = new Color(0.5f, 0.5f, 0.5f, 1.0f);
        [SerializeField] private Color _rolesDefinedColor = new Color(0.8f, 0.6f, 1.0f, 1.0f);

        private protected PortalLibrarySystem2 _pls;

        private int           _index;
        private RectTransform _rect;
        private float         _height;
        private bool          _isRolesDefined; 

        public int   Index  { get { return _index;  } }
        public float Height { get { return _height; } }
        
        private protected void _Initialize(int index, string text, bool isRolesDefined)
        {
            _index          = index;
            _rect           = GetComponent<RectTransform>();
            _height         = _rect.offsetMax.y - _rect.offsetMin.y;
            _pls            = GetComponentInParent<PortalLibrarySystem2>();
            _isRolesDefined = isRolesDefined;
            
            _rect.offsetMax = new Vector2(0, -( _index      * _height));
            _rect.offsetMin = new Vector2(0, -((_index + 1) * _height));
            
            _text.GetComponent<TextMeshProUGUI>().text = text;

            SetButtonState(ButtonState.Unselected);
        }
        
        private protected void SetButtonState(ButtonState state)
        {
            switch (state)
            {
                case ButtonState.Unselected:
                    _background.color = _isRolesDefined ? _rolesDefinedColor : _unselectedColor;
                    break;
                case ButtonState.Selected:
                    _background.color = _selectedColor;
                    break;
                case ButtonState.Invalid:
                    _background.color = _invalidColor;
                    break;
            }
        }
    }

    public enum ButtonState
    {
        Unselected, Selected, Invalid
    }
}


using UdonSharp;
using UnityEngine;
using UnityEngine.UI;
using VRC.SDKBase;
using VRC.Udon;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class ButtonBackground : UdonSharpBehaviour
    {
        [SerializeField] private Image _img;
        [SerializeField] private Color _unselectedColor = Color.white;
        [SerializeField] private Color _selectedColor   = new Color(0.5f, 1.0f, 1.0f, 1.0f);
        [SerializeField] private Color _invalidColor    = new Color(0.5f, 0.5f, 0.5f, 1.0f);

        public void SetBackground(ButtonState state)
        {
            switch (state)
            {
                case ButtonState.Unselected:
                    _img.color = _unselectedColor;
                    break;
                case ButtonState.Selected:
                    _img.color = _selectedColor;
                    break;
                case ButtonState.Invalid:
                    _img.color = _invalidColor;
                    break;
            }
        }
    }
}

using UdonSharp;
using UnityEngine;
using VRC.SDKBase;
using VRC.SDK3.Data;
using VRC.Udon;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class Category : UdonSharpBehaviour
    {
        [SerializeField] private string   _categoryName;
        [SerializeField] private string[] _permittedRoles;

        public DataToken GetDataToken()
        {
            DataToken data = new DataToken(new DataDictionary());
            data.DataDictionary["Category"] = _categoryName;
            data.DataDictionary["Worlds"]   = new DataToken(new DataList());

            for (int i = 0; i < this.transform.childCount; i++)
            {
                var obj = this.transform.GetChild(i).gameObject;

                if (obj.activeSelf)
                {
                    var world = obj.GetComponent<World>();
                    if (world != null) data.DataDictionary["Worlds"].DataList.Add(world.GetDataToken());
                }
            }

            if (_permittedRoles.Length > 0)
            {
                data.DataDictionary["PermittedRoles"] = new DataToken(new DataList());

                foreach (var role in _permittedRoles)
                {
                    data.DataDictionary["PermittedRoles"].DataList.Add(role);
                }
            }

            return data;
        }
    }
}
using UdonSharp;
using UnityEngine;
using VRC.SDKBase;
using VRC.Udon;
using TMPro;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class CategoryButton : Button
    {
        public void Initialize(int index, string text, bool isRolesDefined)
        {
            base._Initialize(index, text, isRolesDefined);
        }
        
        public void OnClicked()
        {
            _pls.OnCategoryButtonClicked(Index);
        }

        public void UpdateButtonState(int index)
        {
            if (Index == index)
            {
                SetButtonState(ButtonState.Selected);
            }
            else
            {
                SetButtonState(ButtonState.Unselected);
            }
        }
    }
}
using UdonSharp;
using UnityEngine;
using VRC.SDKBase;
using VRC.SDK3.Data;
using VRC.Udon;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class Categorys : UdonSharpBehaviour
    {
        public DataToken GetDataToken()
        {
            DataToken data = new DataToken(new DataList());

            for (int i = 0; i < this.transform.childCount; i++)
            {
                var obj = this.transform.GetChild(i).gameObject;

                if (obj.activeSelf)
                {
                    var category = obj.GetComponent<Category>();
                    if (category != null) data.DataList.Add(category.GetDataToken());
                }
            }

            return data;
        }
    }
}
using System;
using UdonSharp;
using UnityEngine;
using VRC.SDKBase;
using VRC.SDK3.Data;
using VRC.Udon;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class CategorySelector : Selector
    {
        private CategoryButton[] _categoryButtons;
        
        public void GenerateButtons(DataToken data)
        {
            SetLoadingEffectActive(false);
            DestroyButtons();

            _buttons         = new GameObject[data.DataList.Count];
            _categoryButtons = new CategoryButton[data.DataList.Count];

            if (_pIndex == -1)
            {
                // _pIndex が -1 でない時は、現在走っている _GenerateButtonsLoop を利用する
                SendCustomEventDelayedFrames(nameof(_GenerateButtonsLoop), 1);
            }

            _pIndex = 0;
            _pData  = data;
        }

        // Button の生成には1つあたり2ms程度の時間がかかるため、
        // 1フレームで全ての Button を生成すると処理落ちを起こしてしまう。
        // スクロールしない状態で生成されていないといけない Button の数を求めて、
        // 1フレームにつき、その数の Button を生成するような処理を書いている。
        public void _GenerateButtonsLoop()
        {
            int step = 0;

            while (true)
            {
                _buttons[_pIndex]         = Instantiate(_buttonTemplate, _parentOfButtons);
                _categoryButtons[_pIndex] = _buttons[_pIndex].GetComponent<CategoryButton>();

                var text           = DataUtil.ForceString(_pData.DataList[_pIndex].DataDictionary["Category"]);
                var isRolesDefined = _pData.DataList[_pIndex].DataDictionary.ContainsKey("PermittedRoles");

                _categoryButtons[_pIndex].Initialize(_pIndex, text, isRolesDefined);

                if (_pIndex == 0)
                {
                    SetScrollAreaHeight(_categoryButtons[0].Height * _pData.DataList.Count);
                    Select(0);
                }

                if (step == 0) step = (int) Math.Ceiling(GetViewPortHeight() / _categoryButtons[0].Height);

                _pIndex += 1;

                if (_pIndex == _pData.DataList.Count)
                {
                    _pIndex = -1;
                    break;
                }
                else if (_pIndex % step == 0)
                {
                    SendCustomEventDelayedFrames(nameof(_GenerateButtonsLoop), 1);
                    break;
                }
            }
        }

        public override void Select(int index)
        {
            base.Select(index);
            
            foreach (var cb in _categoryButtons)
            {
                if (cb != null) cb.UpdateButtonState(index);
            }
        }
    }
}
using VRC.SDK3.Data;

namespace Wacky612.PortalLibrarySystem2
{
    public static class DataUtil
    {
        public static DataToken Null()
        {
            return new DataToken(TokenType.Null);
        }
        
        public static int ForceInt(DataToken data)
        {
            return data.IsNumber ? (int) data.Number : 0;
        }

        public static string ForceString(DataToken data)
        {
            return (data.TokenType == TokenType.String) ? data.String : "";
        }

        public static bool ForceBool(DataToken data)
        {
            return (data.TokenType == TokenType.Boolean) ? data.Boolean : false;
        }

        public static DataToken ForceValue(DataToken data, string key)
        {
            if (data.TokenType == TokenType.DataDictionary && data.DataDictionary.ContainsKey(key))
            {
                return data.DataDictionary[key];
            }
            else
            {
                return DataUtil.Null();
            }
        }

        public static int ForceValueInt(DataToken data, string key)
        {
            return ForceInt(ForceValue(data, key));
        }

        public static string ForceValueString(DataToken data, string key)
        {
            return ForceString(ForceValue(data, key));
        }

        public static bool ForceValueBool(DataToken data, string key)
        {
            return ForceBool(ForceValue(data, key));
        }

        public static DataList Intersection(DataList a, DataList b)
        {
            var ans = new DataList();

            for (int i = 0; i < a.Count; i++)
            {
                for (int j = 0; j < b.Count; j++)
                {
                    if (a[i].CompareTo(b[j]) == 0) ans.Add(a[i]);
                }
            }

            return ans;
        }
    }
}
using System;
using UdonSharp;
using UnityEngine;
using VRC.SDKBase;
using VRC.Udon;
using TMPro;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class Description : UdonSharpBehaviour
    {
        [SerializeField] private TextMeshProUGUI _text;
        
        public void UpdateDescription(string description)
        {
            _text.text = description;
        }
    }
}
using UdonSharp;
using UnityEngine;
using UnityEngine.UI;
using VRC.SDKBase;
using VRC.Udon;
using TMPro;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class Information : UdonSharpBehaviour
    {
        [SerializeField] private TextMeshProUGUI  _text;
        [SerializeField] private RawImage         _thumbnail;
        [SerializeField] private GameObject       _creditObj;
        [SerializeField] private GameObject       _descriptionObj;
        [SerializeField] private ButtonBackground _goButtonBackground;
        [SerializeField] private ButtonBackground _creditButtonBackground;
        
        private string  _id;
        private string  _description;
        private Texture _texture;
        private Texture _defaultThumbnailTexture;
        private bool    _isDisplayingCredit;
        
        public string ID { get { return _isDisplayingCredit ? "" : _id; } }

        public void Initialize()
        {
            _defaultThumbnailTexture = _thumbnail.texture;
            UpdateInformation("", "", null);
        }
        
        public void UpdateInformation(string id, string description, Texture texture)
        {
            _id                 = id;
            _description        = description;
            _texture            = texture;
            _isDisplayingCredit = false;

            if (_texture != null && _texture.GetType() == typeof(RenderTexture) &&
                _thumbnail.texture != _texture)
            {
                // Jsonモードで、サムネイル画像を他画像から RenderTexture へと差し替える際
                // RenderTexture に更新前の画像が残っていて一瞬チラつくことがある
                // RenderTexture が更新されるまで10フレームぐらい待つことで対処している
                SendCustomEventDelayedFrames(nameof(_UpdateInformation), 10);
            }
            else
            {
                _UpdateInformation();
            }
        }

        public void _UpdateInformation()
        {
            _creditObj.SetActive(_isDisplayingCredit);
            _descriptionObj.SetActive(!_isDisplayingCredit);

            if (_isDisplayingCredit)
            {
                _goButtonBackground.SetBackground(ButtonState.Invalid);
                _creditButtonBackground.SetBackground(ButtonState.Selected);
            }
            else
            {
                _text.text         = _description;
                _thumbnail.texture = (_texture != null) ? _texture : _defaultThumbnailTexture;

                _goButtonBackground.SetBackground(_id != "" ? ButtonState.Unselected : ButtonState.Invalid);
                _creditButtonBackground.SetBackground(ButtonState.Unselected);
            }
        }

        public void ToggleCredit()
        {
            _isDisplayingCredit = !_isDisplayingCredit;
            _UpdateInformation();
        }
    }
}
using UdonSharp;
using UnityEngine;
using VRC.SDKBase;
using VRC.SDK3.Data;
using VRC.SDK3.StringLoading;
using VRC.Udon;
using VRC.Udon.Common.Interfaces;
using VRC.SDK3.Components.Video;
using VRC.SDK3.Video.Components;

namespace Wacky612.PortalLibrarySystem2
{
    [RequireComponent(typeof(VRCUnityVideoPlayer))]
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class JsonWorldData : BaseWorldData
    {
        [SerializeField] private VRCUrl _jsonUrl;
        [SerializeField] private VRCUrl _thumbnailUrl = null;
        [SerializeField] private float  _worldDataLoadDelaySeconds;
        [SerializeField] private float  _thumbnailsLoadDelaySeconds;
        
        [SerializeField] private RenderTexture _renderTexture;
        
        private VRCUnityVideoPlayer _videoPlayer;
        private float               _videoPlayerTime;

        public override float WorldDataLoadDelaySeconds  { get { return _worldDataLoadDelaySeconds; } }
        public override float ThumbnailsLoadDelaySeconds { get { return _thumbnailsLoadDelaySeconds; } }

        public override void Initialize()
        {
            base.Initialize();
            _videoPlayer = GetComponent<VRCUnityVideoPlayer>();
            _videoPlayer.Loop = false;
            _videoPlayer.EnableAutomaticResync = false;
        }

        public override void LoadWorldData()
        {
            VRCStringDownloader.LoadUrl(_jsonUrl, (IUdonEventReceiver) this);
        }

        public override void LoadThumbnails()
        {
            if (_thumbnailUrl != null) _videoPlayer.LoadURL(_thumbnailUrl);
        }

        public override void OnStringLoadSuccess(IVRCStringDownload result)
        {
            if (result.Url == _jsonUrl && VRCJson.TryDeserializeFromJson(result.Result, out DataToken data))
            {
                _worldDataProcessor.OnWorldDataLoadSuccess(data);
            }
            else
            {
                _worldDataProcessor.OnWorldDataLoadFailed();
            }
        }

        public override void OnStringLoadError(IVRCStringDownload result)
        {
            _worldDataProcessor.OnWorldDataLoadFailed();
        }

        public override void OnVideoReady()
        {
            _videoPlayer.Pause();
            _worldDataProcessor.OnThumbnailsLoadFinish();
        }

        public override void OnVideoError(VideoError videoError)
        {
            _worldDataProcessor.OnThumbnailsLoadFinish();
        }

        public override Texture GetThumbnail(int index)
        {
            if (_videoPlayer.IsReady)
            {
                _videoPlayerTime = index + 1;
                _UpdateRenderTexture();
                return (Texture) _renderTexture;
            }
            else
            {
                return null;
            }
        }

        public void _UpdateRenderTexture()
        {
            _videoPlayer.SetTime(_videoPlayerTime);
            _videoPlayer.Play();
            SendCustomEventDelayedFrames(nameof(_CheckRenderTexture), 10);
        }

        public void _CheckRenderTexture()
        {
            _videoPlayer.Pause();
            var time = _videoPlayer.GetTime();

            if (time < _videoPlayerTime || time >= _videoPlayerTime + 1)
            {
                // まれに、SetTime() しても動画プレイヤーの再生時間が目的の時間にならないことがある
                // 一旦、SetTime(0) した後、_UpdateRenderTexture を再度実行することで対処している

                _videoPlayer.SetTime(0);
                SendCustomEventDelayedFrames(nameof(_UpdateRenderTexture), 10);
            }
        }
    }
}
using UdonSharp;
using UnityEngine;
using UnityEngine.UI;
using VRC.SDKBase;
using VRC.SDK3.Data;
using VRC.Udon;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class PortalLibrarySystem2 : UdonSharpBehaviour
    {
        [SerializeField] private PortalManager _portalManager;

        private WorldDataProcessor _worldDataProcessor;
        private CategorySelector   _categorySelector;
        private WorldSelector      _worldSelector;
        private Information        _information;

        private void Start()
        {
            _worldDataProcessor = GetComponentInChildren<WorldDataProcessor>();
            _categorySelector   = GetComponentInChildren<CategorySelector>();
            _worldSelector      = GetComponentInChildren<WorldSelector>();
            _information        = GetComponentInChildren<Information>();

            _worldDataProcessor.Initialize();
            _categorySelector.Initialize();
            _worldSelector.Initialize();
            _information.Initialize();

            if (_portalManager != null)
            {
                SendCustomEventDelayedSeconds(nameof(_LoadWorldData),
                                              _worldDataProcessor.WorldDataLoadDelaySeconds);
                SendCustomEventDelayedSeconds(nameof(_LoadThumbnails),
                                              _worldDataProcessor.ThumbnailsLoadDelaySeconds);
            }
            else
            {
                string text = "Error: PortalManagerが設定されていません！！";
                _information.UpdateInformation("", text, null);
            }
        }

        public void Reload()
        {
            _LoadWorldData();
            _LoadThumbnails();
        }

        public void _LoadWorldData()
        {
            _worldDataProcessor.LoadWorldData();
        }

        public void _LoadThumbnails()
        {
            _worldDataProcessor.LoadThumbnails();
        }

        public void OnWorldDataLoaded()
        {
            if (_worldDataProcessor.Categorys.DataList.Count > 0)
            {
                _categorySelector.GenerateButtons(_worldDataProcessor.Categorys);
                _worldSelector.GenerateButtons(_worldDataProcessor.GetCategory(0).DataDictionary["Worlds"]);
                _information.UpdateInformation("", "", null);
            }
            else
            {
                string text = "Error: ワールドのデータが1つも登録されていません！";
                _information.UpdateInformation("", text, null);                
            }
        }          

        public void OnCategoryButtonClicked(int index)
        {
            if (index != _categorySelector.Index)
            {
                _categorySelector.Select(index);
                _worldSelector.GenerateButtons(_worldDataProcessor.GetCategory(index).DataDictionary["Worlds"]);
            }
        }

        public void OnWorldButtonClicked(int index)
        {
            if (index != _worldSelector.Index)
            {
                _worldSelector.Select(index);

                var thumbnailIndex = DataUtil.ForceValueInt(GetSelectedWorld(), "ThumbnailIndex");
                
                _information.UpdateInformation(DataUtil.ForceValueString(GetSelectedWorld(), "ID"),
                                               DataUtil.ForceValueString(GetSelectedWorld(), "Description"),
                                               _worldDataProcessor.GetThumbnail(thumbnailIndex));
            }
        }

        public void GeneratePortal()
        {
            if (_information.ID != "") _portalManager.GeneratePortal(_information.ID);
        }

        public void ResetPortal()
        {
            _portalManager.ResetPortal();
        }

        private DataToken GetSelectedWorld()
        {
            int c = _categorySelector.Index;
            int w = _worldSelector.Index;

            return _worldDataProcessor.GetWorld(c, w);
        }
    }
}
using UdonSharp;
using UnityEngine;
using VRC.SDKBase;
using VRC.SDK3.Data;
using VRC.SDK3.Components;
using VRC.Udon;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.Manual)]
    public class PortalManager : UdonSharpBehaviour
    {
        [SerializeField] private bool _isGlobal = true;
        
        private VRCPortalMarker[] _portals;
        private int               _index;

        [UdonSynced]
        private string _json;

        private void Start()
        {
            _portals = GetComponentsInChildren<VRCPortalMarker>();

            if (_isGlobal)
            {
                if (Networking.IsOwner(this.gameObject)) ResetPortal();
            }
            else
            {
                ResetPortal();
            }
        }

        public void GeneratePortal(string id)
        {
            if (_portals != null)
            {
                _index = (_index + 1) % _portals.Length;

                SetPortalID(_portals[_index], id);
                _RequestSerialization();
            }
        }

        public void ResetPortal()
        {
            if (_portals != null)
            {
                foreach (var portal in _portals) SetPortalID(portal, "");

                _index = -1;
                _RequestSerialization();
            }
        }

        private void SetPortalID(VRCPortalMarker portal, string id)
        {
            portal.roomId = id;
            portal.gameObject.SetActive(id != "");
        }

        private void _RequestSerialization()
        {
            if (_isGlobal)
            {
                Networking.SetOwner(Networking.LocalPlayer, this.gameObject);
                RequestSerialization();
            }
        }

        public override void OnPreSerialization()
        {
            var data = new DataDictionary();
            data["Index"]   = _index;
            data["RoomIDs"] = new DataList();

            foreach (var portal in _portals) data["RoomIDs"].DataList.Add(portal.roomId);

            if (VRCJson.TrySerializeToJson(data, JsonExportType.Minify, out DataToken result))
            {
                _json = result.String;
            }
        }

        public override void OnDeserialization()
        {
            if (_isGlobal) _TryToDecodeJson();
        }

        public void _TryToDecodeJson()
        {
            if (_portals != null)
            {
                DecodeJson();
            }
            else
            {
                SendCustomEventDelayedFrames(nameof(_TryToDecodeJson), 1);
            }
        }

        private void DecodeJson()
        {
            if (VRCJson.TryDeserializeFromJson(_json, out DataToken result))
            {
                var data = result.DataDictionary;
                
                _index = (int) data["Index"].Double;

                for (int i = 0; i < _portals.Length; i++)
                {
                    SetPortalID(_portals[i], data["RoomIDs"].DataList[i].String);
                }
            }
        }
    }
}
using UdonSharp;
using UnityEngine;
using VRC.SDKBase;
using VRC.SDK3.Data;
using VRC.Udon;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class Role : UdonSharpBehaviour
    {
        [SerializeField] private string   _roleName;
        [SerializeField] private string[] _displayNames;

        public DataToken GetDataToken()
        {
            DataToken data = new DataToken(new DataDictionary());
            data.DataDictionary["RoleName"]     = _roleName;
            data.DataDictionary["DisplayNames"] = new DataToken(new DataList());

            foreach (var displayName in _displayNames)
            {
                data.DataDictionary["DisplayNames"].DataList.Add(displayName);
            }

            return data;
        }
    }
}
using UdonSharp;
using UnityEngine;
using VRC.SDKBase;
using VRC.SDK3.Data;
using VRC.Udon;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class Roles : UdonSharpBehaviour
    {
        public DataToken GetDataToken()
        {
            DataToken data = new DataToken(new DataList());

            for (int i = 0; i < this.transform.childCount; i++)
            {
                var obj = this.transform.GetChild(i).gameObject;

                if (obj.activeSelf)
                {
                    var role = obj.GetComponent<Role>();
                    if (role != null) data.DataList.Add(role.GetDataToken());
                }
            }

            return data;
        }
    }
}
using UdonSharp;
using UnityEngine;
using UnityEngine.UI;
using VRC.SDKBase;
using VRC.SDK3.Data;
using VRC.Udon;

namespace Wacky612.PortalLibrarySystem2
{
    public abstract class Selector : UdonSharpBehaviour
    {
        [SerializeField] private protected GameObject _buttonTemplate;
        [SerializeField] private protected Transform  _parentOfButtons;
        [SerializeField] private           GameObject _parentOfTemplate;
        [SerializeField] private           GameObject _loadingEffect;

        private protected int          _pIndex;
        private protected DataToken    _pData;
        private protected GameObject[] _buttons;
        private           ScrollRect   _scrollRect;

        private int _index;
        public  int Index { get { return _index; }}

        public void Initialize()
        {
            _scrollRect = GetComponentInChildren<ScrollRect>();
            _parentOfTemplate.SetActive(false);
            SetScrollAreaHeight(0);            
            SetLoadingEffectActive(true);
            _pIndex = -1;
        }

        public virtual void Select(int index)
        {
            _index = index;
        }

        private protected void DestroyButtons()
        {
            if (_buttons != null)
            {
                foreach (var obj in _buttons)
                {
                    if (Utilities.IsValid(obj)) GameObject.Destroy(obj);
                }
            }
        }

        private protected void SetScrollAreaHeight(float height)
        {
            _scrollRect.verticalNormalizedPosition = 1.0f;
            _scrollRect.content.offsetMin          = new Vector2(0, -height);
        }

        private protected float GetViewPortHeight()
        {
            return _scrollRect.viewport.rect.height;
        }

        private protected void SetLoadingEffectActive(bool b)
        {
            _loadingEffect.SetActive(b);
        }
    }
}
using UdonSharp;
using UnityEngine;
using VRC.SDKBase;
using VRC.SDK3.Data;
using VRC.Udon;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class StaticWorldData : BaseWorldData
    {
        [SerializeField] private bool _reverseCategorys = false;
        [SerializeField] private bool _showPrivateWorld = false;

        private Texture2D[] _thumbnails;

        public override float WorldDataLoadDelaySeconds  { get { return 0; } }
        public override float ThumbnailsLoadDelaySeconds { get { return 0; } }
        
        public override void LoadWorldData()
        {
            _worldDataProcessor.OnWorldDataLoadSuccess(ConstructWorldData());
        }

        public override void LoadThumbnails()
        {
            ConstructThumbnails();
            _worldDataProcessor.OnThumbnailsLoadFinish();
        }

        public DataToken ConstructWorldData()
        {
            DataToken data = new DataToken(new DataDictionary());          
            data.DataDictionary["ReverseCategorys"] = _reverseCategorys;
            data.DataDictionary["ShowPrivateWorld"] = _showPrivateWorld;
            data.DataDictionary["Categorys"]        = GetComponentInChildren<Categorys>().GetDataToken();
            data.DataDictionary["Roles"]            = GetComponentInChildren<Roles>().GetDataToken();

            return data;
        }

        private void ConstructThumbnails()
        {
            var worlds  = GetComponentsInChildren<World>();
            _thumbnails = new Texture2D[worlds.Length];

            for (int i = 0; i < worlds.Length; i++)
            {
                _thumbnails[i] = worlds[i].Thumbnail;
            }
        }

        public override Texture GetThumbnail(int index)
        {
            return (Texture) _thumbnails[index];
        }
    }
}
using UdonSharp;
using UnityEngine;
using VRC.SDKBase;
using VRC.SDK3.Data;
using VRC.Udon;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class World : UdonSharpBehaviour
    {
        [SerializeField] private string        _id;
        [SerializeField] private string        _name;
        [SerializeField] private int           _recommendedCapacity = 0;
        [SerializeField] private int           _capacity            = 0;
        [SerializeField] private ReleaseStatus _releaseStatus       = ReleaseStatus.Public;
        [SerializeField] private bool          _pc                  = false;
        [SerializeField] private bool          _android             = false;
        [SerializeField] private bool          _ios                 = false;
        [TextArea(3,12)]
        [SerializeField] private string        _description;
        [SerializeField] private Texture2D     _thumbnail;
        [SerializeField] private string[]      _permittedRoles;

        public Texture2D Thumbnail { get { return _thumbnail; } }
        
        public DataToken GetDataToken()
        {
            DataToken data = new DataToken(new DataDictionary());
            
            data.DataDictionary["ID"]                  = _id;
            data.DataDictionary["Name"]                = _name;
            data.DataDictionary["RecommendedCapacity"] = _recommendedCapacity;
            data.DataDictionary["Capacity"]            = _capacity;
            data.DataDictionary["Description"]         = _description;

            if (_pc || _android || _ios)
            {
                data.DataDictionary["Platform"] = new DataToken(new DataDictionary());
                data.DataDictionary["Platform"].DataDictionary["PC"]      = _pc;
                data.DataDictionary["Platform"].DataDictionary["Android"] = _android;
                data.DataDictionary["Platform"].DataDictionary["iOS"]     = _ios;
            }

            switch (_releaseStatus)
            {
                case ReleaseStatus.Public:
                    data.DataDictionary["ReleaseStatus"] = "public";
                    break;
                case ReleaseStatus.Private:
                    data.DataDictionary["ReleaseStatus"] = "private";
                    break;
            }

            if (_permittedRoles.Length > 0)
            {
                data.DataDictionary["PermittedRoles"] = new DataToken(new DataList());

                foreach (var role in _permittedRoles)
                {
                    data.DataDictionary["PermittedRoles"].DataList.Add(role);
                }
            }

            return data;
        }
    }

    public enum ReleaseStatus
    {
        Public, Private
    }
}
using UdonSharp;
using UnityEngine;
using UnityEngine.UI;
using VRC.SDKBase;
using VRC.Udon;
using TMPro;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class WorldButton : Button
    {
        [SerializeField] private RectTransform _capacitys;
        [SerializeField] private RectTransform _capacity;
        [SerializeField] private RectTransform _slash;
        [SerializeField] private RectTransform _recommendedCapacity;

        [SerializeField] private RectTransform _platform;
        [SerializeField] private GameObject    _pc;
        [SerializeField] private GameObject    _android;
        [SerializeField] private GameObject    _ios;

        private string   _id;

        public void Initialize(int index, string text, bool isRolesDefined,
                               string id, int capacity, int recommendedCapacity,
                               bool pc, bool android, bool ios)
        {
            base._Initialize(index, text, isRolesDefined);

            _capacity.GetComponent<TextMeshProUGUI>().text            = capacity.ToString();
            _recommendedCapacity.GetComponent<TextMeshProUGUI>().text = recommendedCapacity.ToString();

            var capacitysWidth = SetCapacitysWidth(0, capacity, recommendedCapacity);
            var platformWidth  = SetPlatformWidth(capacitysWidth, pc, android, ios);

            _text.offsetMax = new Vector2(-(capacitysWidth + platformWidth), 0);

            _id = id;

            UpdateButtonState(-1);
        }

        private float SetCapacitysWidth(float offset, int capacity, int recommendedCapacity)
        {
            SetRectActive(_capacity           , capacity > 0);
            SetRectActive(_slash              , capacity > 0 && recommendedCapacity > 0);
            SetRectActive(_recommendedCapacity, capacity > 0 && recommendedCapacity > 0);

            float capacitysWidth = (GetRectWidth(_capacity) + GetRectWidth(_slash) +
                                    GetRectWidth(_recommendedCapacity));

            _capacitys.offsetMax = new Vector2(-(offset),                  0);
            _capacitys.offsetMin = new Vector2(-(offset + capacitysWidth), 0);

            return capacitysWidth;
        }

        private float SetPlatformWidth(float offset, bool pc, bool android, bool ios)
        {
            _pc.SetActive(pc);
            _android.SetActive(android);
            _ios.SetActive(ios);

            float platformWidth = pc || android || ios ? GetRectWidth(_platform) : 0;

            _platform.offsetMax = new Vector2(-(offset),                 0);
            _platform.offsetMin = new Vector2(-(offset + platformWidth), 0);

            return platformWidth;
        }
        
        public void OnClicked()
        {
            if (!string.IsNullOrEmpty(_id))
            {
                _pls.OnWorldButtonClicked(Index);
            }
        }

        public void UpdateButtonState(int index)
        {
            if (string.IsNullOrEmpty(_id))
            {
                SetButtonState(ButtonState.Invalid);
            }
            else if (Index == index)
            {
                SetButtonState(ButtonState.Selected);
            }
            else
            {
                SetButtonState(ButtonState.Unselected);
            }
        }

        private void SetRectActive(RectTransform rect, bool b)
        {
            rect.gameObject.SetActive(b);
        }

        private float GetRectWidth(RectTransform rect)
        {
            return rect.gameObject.activeSelf ? rect.rect.width : 0;
        }
    }
}
using UdonSharp;
using UnityEngine;
using VRC.SDKBase;
using VRC.SDK3.Data;
using VRC.Udon;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class WorldDataProcessor : UdonSharpBehaviour
    {
        [SerializeField] private DataType _dataType;

        private PortalLibrarySystem2 _pls;
        private BaseWorldData        _worldData;

        private DataList _obtainedRoles;
        private bool     _showPrivateWorld;
        private bool     _reverseCategorys;
        private bool     _isLoadingWorldData;
        private bool     _isLoadingThumbnails;

        private DataToken _categorys;        
        public  DataToken Categorys { get { return _categorys; } }

        public DataType DataType                   { get { return _dataType; } }
        public float    WorldDataLoadDelaySeconds  { get { return _worldData.WorldDataLoadDelaySeconds; } }
        public float    ThumbnailsLoadDelaySeconds { get { return _worldData.ThumbnailsLoadDelaySeconds; } }

        public void Initialize()
        {
            _pls       = GetComponentInParent<PortalLibrarySystem2>();
            _isLoadingWorldData  = false;
            _isLoadingThumbnails = false;

            switch (_dataType)
            {
                case DataType.Static:
                    _worldData = (BaseWorldData) GetComponentInChildren<StaticWorldData>();
                    break;
                case DataType.Json:
                    _worldData = (BaseWorldData) GetComponentInChildren<JsonWorldData>();
                    break;
            }

            _worldData.Initialize();
        }
        
        public void LoadWorldData()
        {
            if (!_isLoadingWorldData)
            {
                _isLoadingWorldData = true;
                _worldData.LoadWorldData();
            }
        }

        public void LoadThumbnails()
        {
            if (!_isLoadingThumbnails)
            {
                _isLoadingThumbnails = true;
                _worldData.LoadThumbnails();
            }
        }

        public void OnThumbnailsLoadFinish()
        {
            _isLoadingThumbnails = false;
        }

        public Texture GetThumbnail(int index)
        {
            return _worldData.GetThumbnail(index);
        }
        
        public void OnWorldDataLoadSuccess(DataToken data)
        {
            _categorys        = data.DataDictionary["Categorys"];
            _obtainedRoles    = GetObtainedRoles(data);
            _showPrivateWorld = DataUtil.ForceValueBool(data, "ShowPrivateWorld");
            _reverseCategorys = DataUtil.ForceValueBool(data, "ReverseCategorys");

            SendCustomEventDelayedFrames(nameof(_AppendThumbnailIndex), 1);
            SendCustomEventDelayedFrames(nameof(_ApplyPermission),      2);
            SendCustomEventDelayedFrames(nameof(_HidePrivateWorld),     3);
            SendCustomEventDelayedFrames(nameof(_ReturnToPLS),          4);
        }

        public void OnWorldDataLoadFailed()
        {
            _isLoadingWorldData = false;
        }

        public void _AppendThumbnailIndex()
        {
            int i = 0;
            
            for (int c = 0; c < _categorys.DataList.Count; c++)
            {
                for (int w = 0; w < GetCategory(c).DataDictionary["Worlds"].DataList.Count; w++)
                {
                    GetWorld(c, w).DataDictionary["ThumbnailIndex"] = new DataToken(i);
                    i++;
                }
            }
        }

        public void _ApplyPermission()
        {
            for (int c = 0; c < _categorys.DataList.Count; c++)
            {
                var forbiddenWorldIndexes = GetForbiddenWorldIndexes(c, _obtainedRoles);
                forbiddenWorldIndexes.Reverse();

                for (int i = 0; i < forbiddenWorldIndexes.Count; i++)
                {
                    GetCategory(c).DataDictionary["Worlds"].DataList.RemoveAt(forbiddenWorldIndexes[i].Int);
                }
            }

            var forbiddenCategoryIndexes = GetForbiddenCategoryIndexes(_obtainedRoles);
            forbiddenCategoryIndexes.Reverse();
            
            for (int i = 0; i < forbiddenCategoryIndexes.Count; i++)
            {
                _categorys.DataList.RemoveAt(forbiddenCategoryIndexes[i].Int);
            }
        }
        
        public void _HidePrivateWorld()
        {
            if (!_showPrivateWorld)
            {
                for (int c = 0; c < _categorys.DataList.Count; c++)
                {
                    for (int w = 0; w < GetCategory(c).DataDictionary["Worlds"].DataList.Count; w++)
                    {
                        var releaseStatus = DataUtil.ForceValueString(GetWorld(c, w), "ReleaseStatus");

                        if (releaseStatus == "private") GetWorld(c, w).DataDictionary["ID"] = new DataToken("");
                    }
                }
            }
        }

        public void _ReturnToPLS()
        {
            if (_reverseCategorys) _categorys.DataList.Reverse();
            _isLoadingWorldData = false;
            _pls.OnWorldDataLoaded();
        }

        private DataList GetObtainedRoles(DataToken data)
        {
            var obtainedRoles = new DataList();
            
            if (data.DataDictionary.ContainsKey("Roles"))
            {
                for (int i = 0; i < data.DataDictionary["Roles"].DataList.Count; i++)
                {
                    var role = data.DataDictionary["Roles"].DataList[i].DataDictionary;
                    
                    if (role["DisplayNames"].DataList.Contains(Networking.LocalPlayer.displayName))
                    {
                        obtainedRoles.Add(role["RoleName"]);
                    }
                }
            }

            return obtainedRoles;
        }

        private DataList GetForbiddenCategoryIndexes(DataList obtainedRoles)
        {
            var forbiddenCategoryIndexes = new DataList();
            
            for (int c = 0; c < _categorys.DataList.Count; c++)
            {
                if (GetCategory(c).DataDictionary.ContainsKey("PermittedRoles"))
                {
                    var categoryPermittedRoles = GetCategory(c).DataDictionary["PermittedRoles"].DataList;
                    
                    if (DataUtil.Intersection(obtainedRoles, categoryPermittedRoles).Count == 0)
                    {
                        forbiddenCategoryIndexes.Add(c);
                    }
                }
            }

            return forbiddenCategoryIndexes;
        }
        
        private DataList GetForbiddenWorldIndexes(int c, DataList obtainedRoles)
        {
            var forbiddenWorldIndexes = new DataList();

            for (int w = 0; w < GetCategory(c).DataDictionary["Worlds"].DataList.Count; w++)
            {
                if (GetWorld(c, w).DataDictionary.ContainsKey("PermittedRoles"))
                {
                    var worldPermittedRoles = GetWorld(c, w).DataDictionary["PermittedRoles"].DataList;
                    
                    if (DataUtil.Intersection(obtainedRoles, worldPermittedRoles).Count == 0)
                    {
                        forbiddenWorldIndexes.Add(w);
                    }                        
                }
            }

            return forbiddenWorldIndexes;
        }

        public DataToken GetCategory(int c)
        {
            return _categorys.DataList[c];
        }
        
        public DataToken GetWorld(int c, int w)
        {
            return _categorys.DataList[c].DataDictionary["Worlds"].DataList[w];
        }
    }

    public enum DataType
    {
        Static, Json
    }
}
using System;
using UdonSharp;
using UnityEngine;
using VRC.SDKBase;
using VRC.SDK3.Data;
using VRC.Udon;

namespace Wacky612.PortalLibrarySystem2
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class WorldSelector : Selector
    {
        private WorldButton[] _worldButtons;

        public void GenerateButtons(DataToken data)
        {
            SetLoadingEffectActive(false);
            DestroyButtons();

            _buttons      = new GameObject[data.DataList.Count];
            _worldButtons = new WorldButton[data.DataList.Count];

            if (_pIndex == -1)
            {
                // _pIndex が -1 でない時は、現在走っている _GenerateButtonsLoop を利用する
                SendCustomEventDelayedFrames(nameof(_GenerateButtonsLoop), 1);
            }

            _pIndex = 0;
            _pData  = data;
        }

        // Button の生成には1つあたり2ms程度の時間がかかるため、
        // 1フレームで全ての Button を生成すると処理落ちを起こしてしまう。
        // スクロールしない状態で生成されていないといけない Button の数を求めて、
        // 1フレームにつき、その数の Button を生成するような処理を書いている。
        public void _GenerateButtonsLoop()
        {
            int step = 0;
            
            if (_pData.DataList.Count == 0)
            {
                _pIndex = -1;
                return;
            }

            while (true)
            {
                _buttons[_pIndex]      = Instantiate(_buttonTemplate, _parentOfButtons);
                _worldButtons[_pIndex] = _buttons[_pIndex].GetComponent<WorldButton>();

                var text                = DataUtil.ForceString(_pData.DataList[_pIndex].DataDictionary["Name"]);
                var id                  = DataUtil.ForceString(_pData.DataList[_pIndex].DataDictionary["ID"]);
                var capacity            = DataUtil.ForceValueInt(_pData.DataList[_pIndex], "Capacity");
                var recommendedCapacity = DataUtil.ForceValueInt(_pData.DataList[_pIndex], "RecommendedCapacity");
                var pc                  = IsSupported(_pData.DataList[_pIndex], "PC");
                var android             = IsSupported(_pData.DataList[_pIndex], "Android");
                var ios                 = IsSupported(_pData.DataList[_pIndex], "iOS");
                var isRolesDefined      = _pData.DataList[_pIndex].DataDictionary.ContainsKey("PermittedRoles");

                _worldButtons[_pIndex].Initialize(_pIndex, text, isRolesDefined,
                                                  id, capacity, recommendedCapacity,
                                                  pc, android, ios);

                if (_pIndex == 0)
                {
                    SetScrollAreaHeight(_worldButtons[0].Height * _pData.DataList.Count);
                    Select(-1);
                }

                if (step == 0) step = (int) Math.Ceiling(GetViewPortHeight() / _worldButtons[0].Height);

                _pIndex += 1;

                if (_pIndex == _pData.DataList.Count)
                {
                    _pIndex = -1;
                    break;
                }
                else if (_pIndex % step == 0)
                {
                    SendCustomEventDelayedFrames(nameof(_GenerateButtonsLoop), 1);
                    break;
                }
            }
        }

        public override void Select(int index)
        {
            base.Select(index);
            
            foreach (var wb in _worldButtons)
            {
                if (wb != null) wb.UpdateButtonState(index);
            }
        }

        private bool IsSupported(DataToken data, string key)
        {
            return DataUtil.ForceValueBool(DataUtil.ForceValue(data, "Platform"), key);
        }
    }
}
